{% extends "layout.html" %}

{% block title %}Ledger - Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-header__title">Ledger - Billing & Contract Management</h1>
    <p class="page-header__description">Track client billing, manage contracts, and monitor recurring revenue across all accounts.</p>
</div>

<div class="card">
    <div class="card__body">
        <div class="dashboard-grid dashboard-grid--three-col">
            <a href="/ledger/clients" class="dashboard-card">
                <div class="dashboard-card__icon">
                    <i data-lucide="building-2"></i>
                </div>
                <div class="dashboard-card__content">
                    <h2 class="dashboard-card__title">Total Clients</h2>
                    <p class="dashboard-card__count" id="total-clients-count">
                        <span class="skeleton skeleton-text" style="width: 60px; height: 2rem; display: inline-block;"></span>
                    </p>
                </div>
            </a>

            <a href="/ledger/clients" class="dashboard-card">
                <div class="dashboard-card__icon">
                    <i data-lucide="dollar-sign"></i>
                </div>
                <div class="dashboard-card__content">
                    <h2 class="dashboard-card__title">Monthly Revenue</h2>
                    <p class="dashboard-card__count" id="monthly-revenue">
                        <span class="skeleton skeleton-text" style="width: 100px; height: 2rem; display: inline-block;"></span>
                    </p>
                </div>
            </a>

            <a href="/ledger/clients?filter=active" class="dashboard-card">
                <div class="dashboard-card__icon">
                    <i data-lucide="file-check"></i>
                </div>
                <div class="dashboard-card__content">
                    <h2 class="dashboard-card__title">Active Contracts</h2>
                    <p class="dashboard-card__count" id="active-contracts-count">
                        <span class="skeleton skeleton-text" style="width: 60px; height: 2rem; display: inline-block;"></span>
                    </p>
                </div>
            </a>

            <a href="/ledger/clients?filter=expiring" class="dashboard-card">
                <div class="dashboard-card__icon">
                    <i data-lucide="alert-triangle"></i>
                </div>
                <div class="dashboard-card__content">
                    <h2 class="dashboard-card__title">Expiring Soon</h2>
                    <p class="dashboard-card__count" id="expiring-soon-count">
                        <span class="skeleton skeleton-text" style="width: 60px; height: 2rem; display: inline-block;"></span>
                    </p>
                </div>
            </a>

            <a href="/ledger/archive/" class="dashboard-card">
                <div class="dashboard-card__icon">
                    <i data-lucide="archive"></i>
                </div>
                <div class="dashboard-card__content">
                    <h2 class="dashboard-card__title">Archive</h2>
                    <p class="dashboard-card__description">Historical billing snapshots</p>
                </div>
            </a>

            {% if user.permission_level == 'admin' %}
            <a href="/ledger/admin/settings" class="dashboard-card">
                <div class="dashboard-card__icon">
                    <i data-lucide="settings"></i>
                </div>
                <div class="dashboard-card__content">
                    <h2 class="dashboard-card__title">Admin Settings</h2>
                </div>
            </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadDashboardMetrics() {
        try {
            const response = await fetch('/ledger/api/billing/dashboard?year={{ current_year }}&month={{ current_month }}', {
                credentials: 'same-origin'
            });

            if (!response.ok && response.status === 401) {
                window.location.href = '/ledger/login';
                return;
            }

            const data = await response.json();

            if (data.error || data.warning || !data.companies) {
                // Show zeros if there's an error
                document.getElementById('total-clients-count').innerHTML = '0';
                document.getElementById('monthly-revenue').innerHTML = '$0.00';
                document.getElementById('active-contracts-count').innerHTML = '0';
                document.getElementById('expiring-soon-count').innerHTML = '0';
                return;
            }

            const companies = data.companies;

            // Calculate metrics
            const totalClients = companies.length;

            // Calculate monthly revenue (sum of all total_bill values)
            const monthlyRevenue = companies.reduce((sum, company) => {
                return sum + (parseFloat(company.total_bill) || 0);
            }, 0);

            // Count active contracts (not expired)
            const today = new Date();
            const activeContracts = companies.filter(company => {
                const endDate = company.contract_end_date;
                if (!endDate || endDate === 'N/A' || endDate === 'Month to Month') return true;
                return new Date(endDate) >= today;
            }).length;

            // Count expiring soon (within 30 days)
            const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            const expiringSoon = companies.filter(company => {
                const endDate = company.contract_end_date;
                if (!endDate || endDate === 'N/A' || endDate === 'Month to Month') return false;
                const contractEnd = new Date(endDate);
                return contractEnd >= today && contractEnd <= thirtyDaysFromNow;
            }).length;

            // Update the dashboard cards (remove skeleton and show data)
            document.getElementById('total-clients-count').innerHTML = totalClients;
            document.getElementById('monthly-revenue').innerHTML = '$' + monthlyRevenue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('active-contracts-count').innerHTML = activeContracts;
            document.getElementById('expiring-soon-count').innerHTML = expiringSoon;

        } catch (error) {
            console.error('Error loading dashboard metrics:', error);
            document.getElementById('total-clients-count').innerHTML = 'Error';
            document.getElementById('monthly-revenue').innerHTML = 'Error';
            document.getElementById('active-contracts-count').innerHTML = 'Error';
            document.getElementById('expiring-soon-count').innerHTML = 'Error';
        }
    }

    // Load metrics on page load
    loadDashboardMetrics();
</script>
{% endblock %}
